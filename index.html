<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <title>Hello, world!</title>
</head>
<style>
    * {
        /* color: #fff; */
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
body{
    background-color: #FAFAFA;
}
    a {
        text-decoration: none;
        color: grey;
    }

    .headshot {
        max-width: 50px;
    }

    .theme-btn {
        background-color: #D1701F;
        color: white;
    }

    .theme-btn:hover {
        background-color: #A3622B;
        color: white;

    }

    .table-striped>tbody>tr:nth-of-type(odd) {
        --bs-table-accent-bg: #F0EEFE;
        color: var(--bs-table-striped-color);
    }
   
</style>

<body >
    <div class="container-fluid my-4">
        <div class="row">
            <div class="col-12 mb-3">
                <div class="row align-items-center justify-content-end">
                    <div class="col-md-6 mb-2">
                        <div class="form-group">
                            <label for=""><b>Address</b></label>
                            <input type="text" name="" id="address-input" class="form-control"
                                placeholder="Clark County" aria-describedby="helpId">
                            <small id="helpId" class="text-muted">Enter your address to find and contact your elected
                                representatives.</small>

                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button type="button" id="findBtn" class="btn  theme-btn btn-block">Find
                            Representatives</button>
                    </div>
                </div>
            </div>
            <div class="col-12 " hidden id="outputDiv">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Representatives</h4>
                        <div class="table-responsive">
                            <table class="table table-striped" id="repTable">
                                <thead>
                                    <tr>
                                        <th scope="col" width="10%">
                                            <!-- picture  -->
                                        </th>
                                        <th scope="col" width="20%"><b>Representative</b></th>
                                        <th scope="col" width="15%"><b>Office</b></th>
                                        <th scope="col" width="35%"><b>Address</b></th>
                                        <th scope="col" width="10%"><b>Links</b></th>
                                        <th scope="col" width="10%">
                                            <!-- action  -->
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="contactModalTitle"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="contactModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid" id="modalContent"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="lib/jquery.address.js"></script>

    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script> -->

    <script>
        var INFO_API = 'https://www.googleapis.com/civicinfo/v2/representatives';
        var social_icon_lookup = {
            'YouTube': 'youtube',
            'Facebook': 'facebook',
            'Twitter': 'twitter',
            'GooglePlus': 'google-plus'
        };
        var federal_pattern = "ocd-division/country:us";
        var state_pattern = /ocd-division\/country:us\/state:(\D{2}$)/;
        var cd_pattern = /ocd-division\/country:us\/state:(\D{2})\/cd:/;
        var sl_pattern = /ocd-division\/country:us\/state:(\D{2})\/(sldl:|sldu:)/;
        var county_pattern = /ocd-division\/country:us\/state:\D{2}\/county:\D+/;
        var local_pattern = /ocd-division\/country:us\/state:\D{2}\/place:\D+/;
        var district_pattern = /ocd-division\/country:us\/district:\D+/;

        var federal_offices = ['United States Senate', 'United States House of Representatives', 'U.S. Senator', 'U.S. Representative'];
        var social_link_lookup = {
            'YouTube': 'https://www.youtube.com/user/',
            'Facebook': 'https://www.facebook.com/',
            'Twitter': 'https://twitter.com/',
            'GooglePlus': 'https://plus.google.com/'
        };
        function checkFederal(division_id, office_name) {
            if (division_id == federal_pattern ||
                cd_pattern.test(division_id) ||
                federal_offices.indexOf(office_name.name) >= 0)
                return true;
            else
                return false;
        }

        function checkState(division_id) {
            if (state_pattern.test(division_id) ||
                sl_pattern.test(division_id))
                return true;
            else
                return false;
        }

        function checkCounty(division_id) {
            if (county_pattern.test(division_id))
                return true;
            else
                return false;
        }

        function formatParty(party) {
            if (party) {
                if (party == 'Unknown')
                    return '';

                var party_letter = party.charAt(0);
                var css_class = 'label-ind';
                if (party_letter == 'D')
                    css_class = 'label-dem';
                else if (party_letter == 'R')
                    css_class = 'label-rep';

                return "(<span title='" + party + "' class='" + css_class + "'>" + party_letter + "</span>)";
            }
            else
                return '';
        }

        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function (txt) { return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); });
        }

        function convertToPlainString(text) {
            if (text === undefined) return '';
            return decodeURIComponent(text);
        }
        var selected_state = '';
        var selected_county = '';
        var selected_local = '';
        var all_people = {};
        var pseudo_id = 1;
        $(document).ready(function () {
            $('#findBtn').on('click', function () {
                var address = $('#address-input').val();
                if (address == '') {
                    return;
                }
                $.address.parameter('address', encodeURIComponent(address));
                var params = {
                    'key': "AIzaSyC9H8OAbV92lNplhiIzfzqDZuPvVUgXeWE",
                    'address': address
                }
                $.when($.getJSON(INFO_API, params)).then(function (data) {

                    console.log(data);
                    var divisions = data['divisions'];
                    var officials = data['officials'];
                    var offices = data['offices'];
                    selected_state = '';
                    selected_county = '';
                    selected_local = '';
                    all_people = {};
                    pseudo_id = 1;
                    var federal_people = [];
                    var state_people = [];
                    var county_people = [];
                    var local_people = [];
                    $.each(divisions, function (division_id, division) {
                        if (typeof division.officeIndices !== 'undefined') {
                            $.each(division.officeIndices, function (i, office) {
                                var office_name = offices[office];
                                $.each(offices[office]['officialIndices'], function (i, official) {
                                    var info = {
                                        'person': null,
                                        'office': office_name,
                                        'address': null,
                                        'channels': null,
                                        'phones': null,
                                        'urls': null,
                                        'emails': null,
                                        'division_id': division_id,
                                        'pseudo_id': pseudo_id
                                    };
                                    var person = officials[official];
                                    info['person'] = person;

                                    if (typeof person.channels !== 'undefined') {
                                        var channels = [];
                                        $.each(person.channels, function (i, channel) {
                                            if (channel.type != 'GooglePlus' && channel.type != 'YouTube') {
                                                channel['icon'] = social_icon_lookup[channel.type];
                                                channel['link'] = social_link_lookup[channel.type] + channel['id'];
                                                channels.push(channel);
                                            }
                                        });
                                        info['channels'] = channels;
                                    }
                                    if (typeof person.address !== 'undefined') {
                                        info['address'] = person.address;
                                    }
                                    if (typeof person.phones !== 'undefined') {
                                        info['phones'] = person.phones;
                                    }
                                    if (typeof person.urls !== 'undefined') {
                                        info['urls'] = person.urls;
                                    }
                                    if (typeof person.emails !== 'undefined') {
                                        info['emails'] = person.emails;
                                    }
                                    if (checkFederal(division_id, office_name)) {
                                        info['jurisdiction'] = 'Federal Government';
                                        federal_people.push(info);
                                    } else if (checkState(division_id)) {
                                        info['jurisdiction'] = selected_state;
                                        state_people.push(info);
                                    } else if (checkCounty(division_id)) {
                                        info['jurisdiction'] = selected_county;
                                        county_people.push(info);
                                    } else {
                                        info['jurisdiction'] = selected_local;
                                        local_people.push(info);
                                    }
                                    all_people[pseudo_id] = info;
                                    pseudo_id = pseudo_id + 1;

                                });

                            });
                        }
                    });
                    console.log(local_people);
                    console.log(county_people);
                    console.log(state_people);
                    console.log(federal_people);
                    var senator = [];
                    var representatives = [];
                    federal_people.forEach(p => {
                        if (p.office.name = "U.S. Senator" && p.office.roles.indexOf("legislatorUpperBody") != -1) {
                            senator.push(p);
                        }
                    });
                    if (local_people.length > 0) {
                        representatives.push(local_people[0]);
                    }
                    if (county_people.length > 0) {
                        representatives.push(county_people[0]);
                    }
                    if (state_people.length > 0) {
                        for (let i = 0; i < state_people.length; i++) {
                            if (representatives.length < 2) {
                                representatives.push(state_people[i]);
                            }
                        }
                    }
                    console.log(senator);
                    console.log(representatives);
                    var tblHtml = '';
                    var senChannelsHtml = '';
                    if (senator[0].channels != null) {
                        senator[0].channels.forEach(c => {
                            senChannelsHtml += `<a href="${c.link}" class="fa fa-fw fa-${c.icon}" target="_blank"></a>`;
                        });
                    }
                    tblHtml += `<tr>
                                <td>
                                    <img src="${(senator[0].person.photoUrl != undefined) ? senator[0].person.photoUrl : 'images/blank-person.jpg'}" class="img-rounded headshot" alt="${senator[0].person.name}">
                                </td>
                                <td>${senator[0].person.name +" "+formatParty(senator[0].person.party)} </td>
                                <td>${(senator[0].office.name != true && senator[0].office.name != false) ? senator[0].office.name : "U.S. Senator"}</td>
                                <td>${(senator[0].address != null) ? senator[0].address[0].line1 + " " + senator[0].address[0].city + ", " + senator[0].address[0].state + " " + senator[0].address[0].zip : ""}</td>
                                <td>
                                    ${senChannelsHtml}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-warning text-white btn-contact" data-target="#contactModal" data-toggle="modal" data-id="${senator[0].pseudo_id}">Contact</button>
                                </td>
                            </tr>`;
                    representatives.forEach(r => {
                        var repChannelsHtml = '';
                        if (r.channels != null) {
                            r.channels.forEach(c => {
                                repChannelsHtml += `<a href="${c.link}" class="fa me-1 fa-fw fa-${c.icon}" target="_blank"></a>`;

                            });
                        }
                        tblHtml += `<tr>
                                <td>
                                    <img src="${(r.person.photoUrl) ? r.person.photoUrl : 'images/blank-person.jpg'}" class="img-rounded headshot" alt="${r.person.name}">
                                </td>
                                <td>${r.person.name +" "+formatParty(r.person.party)}</td>
                                <td>${(r.office.name != true && r.office.name != false) ? r.office.name : ""}</td>
                                <td>${(r.address != null) ? r.address[0].line1 + " " + r.address[0].city + ", " + r.address[0].state + " " + r.address[0].zip : ""}</td>
                                <td>
                                    ${repChannelsHtml}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-warning text-white btn-contact" data-toggle="modal" data-target="#contactModal" data-id="${r.pseudo_id}">Contact</button>
                                </td>
                            </tr>`;
                    });
                    $('tbody').html(tblHtml);
                    $('#outputDiv').removeAttr('hidden');

                }, function (error) {
                    console.error('Error occurred:', error);
                    $('tbody').html('<tr><td colspan="6" class="text-center text-muted">No representative found for selected address.</td></tr>');
                    $('#outputDiv').removeAttr('hidden');

                });
            });
            $('body').on('click', '.btn-contact', function () {
                var info = all_people[$(this).data('id')];
                var phonesHtml = '';
                var emailsHtml = '';
                $('#contactModalTitle').text("Contact " + info.person.name)
                if (info.phones) {
                    $.each(info.phones, function (i, phone) {
                        if ((i + 1) < info.phones.length) {
                            phonesHtml += `<i class='fa fa-fw fa-phone'></i>${phone}<br>`;
                        } else {
                            phonesHtml += `<i class='fa fa-fw fa-phone'></i>${phone}`;
                        }
                    });
                }
                if (info.emails) {
                    $.each(info.emails, function (i, email) {
                        if ((i + 1) < info.emails.length) {
                            emailsHtml += `<i class='fa fa-fw fa-envelope'></i> <a href='mailto:${email}'>${email}</a><br>`;
                        } else {
                            emailsHtml += `<i class='fa fa-fw fa-envelope'></i> <a href='mailto:${email}'>${email}</a>`;
                        }
                    });
                }
                var modalHtml = `<div class="row">
                    <div class='col-md-5 col-xs-12 '>
                        ${info.person.photoUrl ? '<img class="img-rounded img-fluid" src="' + info.person.photoUrl + '" alt="' + info.person.name + '" title="' + info.person.name + '"  style="max-width: 150px !important;" />' : '<img class="img-rounded img-fluid" src="images/blank-person.jpg" alt="' + info.person.name + '" title="' + info.person.name + '"  style="max-width: 150px !important;" />'}
                    <br />
                    <strong>
                        ${info.person.name}
                        ${formatParty(info.person.party)}
                    </strong><br>
                        ${(info.office.name != true && info.person.name != false) ? info.office.name : 'U.S. Senator'}<br>
                            ${info.jurisdiction}
                        </div>
                        <div class='col-md-7 col-xs-12 '>
                            <p><strong>Contact ${info.person.name}</strong></p>
                            <hr>
                            ${phonesHtml}
                             <br>
                            ${emailsHtml}
                    </div>
                    </div>`;
                $('#modalContent').html(modalHtml);
                $('#contactModal').modal('show');
            })
            // function initAutocomplete() {
            //     const input = document.getElementById('address-input');
            //     const options = {
            //         types: ['geocode'], // Restrict results to geographical locations.
            //     };
            //     const autocomplete = new google.maps.places.Autocomplete(input, options);

            //     // Optional: Add an event listener to get the selected address details.
            //     autocomplete.addListener('place_changed', function () {
            //         const place = autocomplete.getPlace();
            //         if (!place.geometry) {
            //             console.log('No location data for this place.');
            //             return;
            //         }
            //         console.log('Selected place details:');
            //         console.log('Name:', place.name);
            //         console.log('Formatted Address:', place.formatted_address);
            //         console.log('Latitude:', place.geometry.location.lat());
            //         console.log('Longitude:', place.geometry.location.lng());
            //     });
            // }


        });
    </script>

</body>

</html>